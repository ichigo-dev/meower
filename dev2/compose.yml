################################################################################
# Docker containers
################################################################################


################################################################################
# Services
################################################################################
services:

  ##############################################################################
  # System containers
  ##############################################################################

  # Auth server
  auth:
    container_name: meower_auth
    build:
      context: .
      dockerfile: ./docker/services/auth/Dockerfile
    ports:
      - ${AUTH_PORT}:${AUTH_PORT}
    volumes:
      - ./system/auth:/system/auth
      - ./proto/ui_catalog/assets/css/style.css:/system/auth/core/assets/css/ui.css
    environment:
      PORT: ${AUTH_PORT}
    working_dir: /system/auth/core
    command: "cargo watch -x run"
    depends_on:
      - auth_db
    tty: true

  # Auth server DB
  auth_db:
    container_name: meower_auth_db
    build:
      context: .
      dockerfile: ./docker/services/postgres/Dockerfile
    ports:
      - ${AUTH_DB_PORT}:${AUTH_DB_PORT}
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME}
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD}
      POSTGRES_INITDB_ARGS: --encoding=UTF-8
    command: ["-c", "max_connections=200"]
    restart: always
    tty: true


  ##############################################################################
  # Development tools
  ##############################################################################

  # Development tools
  dev:
    container_name: meower_dev
    build:
      context: .
      dockerfile: ./docker/services/dev/Dockerfile
    volumes:
      - ./system:/system
      - ./proto:/proto
    tty: true

  # mailhog
  mailhog:
    container_name: meower_mailhog
    image: mailhog/mailhog:latest
    ports:
      - ${MAILHOG_PORT}:8025
      - ${MAILHOG_SMTP_PORT}:1025
    environment:
      MH_STORAGE: maildir
      MH_MAILDIR_PATH: /tmp
    volumes:
      - mailhog_data:/tmp

  # tbls
  tbls:
    container_name: meower_tbls
    image: k1low/tbls:latest
    volumes:
      - ${TBLS_OUTPUT_PATH}:/work
    working_dir: /work
    depends_on:
      - auth_db
    tty: true

  # UI catalog
  ui:
    container_name: meower_ui
    build:
      context: .
      dockerfile: ./docker/services/ui/Dockerfile
    ports:
      - ${UI_CATALOG_PORT}:8030
    volumes:
      - ./proto/ui_catalog:/proto/ui_catalog
      - ui_catalog_node_modules:/proto/ui_catalog/node_modules
    working_dir: /proto/ui_catalog
    command: "npx gulp"
    tty: true


################################################################################
# Volumes
################################################################################
volumes:
  auth_db_data:
  mailhog_data:
  ui_catalog_node_modules:
